{% extends "layouts/layout_wide.html" %}

{% set serviceNav = "Services" %}
{% set pageTitle = service.name + " - " + issue.title %}
{% set mainClasses = 'govuk-!-padding-top-0' %}
{% set subnav = 'issues' %}

{% block content %}


{% include "services/department_admin/_subnav.html" %}



<div class="govuk-width-container">
  <div class="govuk-grid-row">

    <div class="govuk-grid-column-full">

      <div style="display: flex; align-items: center; gap: 20px;" class="govuk-!-margin-bottom-1">

        <strong class="govuk-tag govuk-tag--{% if issue.status == 'closed' %}green{% else %}red{% endif %}">{{
          issue.status | replace('_', ' ') | title }}</strong>
        <span class="govuk-caption-l">Issue #{{ issue.numeric_id }}</span>
      </div>
      <h2 class="govuk-heading-l govuk-!-margin-right-2">{{ issue.title }}</h2>
      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
    </div>

    <div class="govuk-grid-column-two-thirds">




      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Description of the issue</h2>
        </div>
        <div class="govuk-summary-card__content">
          
      <p class="govuk-body">{{ issue.description | nl2br | safe }}</p>
        </div>
      </div>


      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Issue information</h2>
        </div>
        <div class="govuk-summary-card__content">
          <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Issue Types
              </dt>
              <dd class="govuk-summary-list__value">
                {% for type in issue.types %}
                  {% if type == 'wcag' %}
                    WCAG{% if issue.wcag_criteria.length > 0 %} - {{ issue.wcag_criteria.length }} criteria{% endif %}
                  {% elif type == 'best_practice' %}
                    Best Practice
                  {% elif type == 'usability' %}
                    Usability
                  {% else %}
                    Not Known
                  {% endif %}
                  {% if not loop.last %}<br>{% endif %}
                {% endfor %}
              </dd>
            </div>
            {% if issue.types.includes('wcag') %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                WCAG Version
              </dt>
              <dd class="govuk-summary-list__value">
                WCAG {{ issue.wcag_criteria[0].version }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                WCAG Criteria
              </dt>
              <dd class="govuk-summary-list__value">
                {% for criterion in issue.wcag_criteria %}
                  <a href="{{ criterion.guidance_url }}" class="govuk-link govuk-link--no-visited-state">
                    {{ criterion.criterion }} - {{ criterion.title }} ({{ criterion.level }})
                  </a>
                  {% if not loop.last %}<br>{% endif %}
                {% endfor %}
              </dd>
            </div>
            {% endif %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Priority
              </dt>
              <dd class="govuk-summary-list__value">
                <strong class="govuk-tag govuk-tag--{% if issue.risk_level == 'high' %}red{% elif issue.risk_level == 'high_medium' %}orange{% elif issue.risk_level == 'medium' %}yellow{% else %}green{% endif %}">
                  {{ issue.risk_level | replace('_', ' ') | title }}
                </strong> <button 
                  class="govuk-link govuk-link--no-visited-state priority-info-button" 
                  onclick="openPriorityInfoModal(); return false;" 
                  aria-label="Open information about how priority is determined"
                  aria-expanded="false"
                  aria-controls="priority-info-modal"
                  aria-haspopup="dialog"
                  data-tooltip="More information about priority levels">
                  <svg 
                    class="priority-info-icon" 
                    width="22" 
                    height="22" 
                    viewBox="0 0 16 16" 
                    fill="none" 
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    focusable="false">
                    <path d="M8 0C3.6 0 0 3.6 0 8C0 12.4 3.6 16 8 16C12.4 16 16 12.4 16 8C16 3.6 12.4 0 8 0ZM8.8 12H7.2V7.2H8.8V12ZM8 6C7.6 6 7.2 5.6 7.2 5.2C7.2 4.8 7.6 4.4 8 4.4C8.4 4.4 8.8 4.8 8.8 5.2C8.8 5.6 8.4 6 8 6Z" 
                      fill="#505A5F"/>
                  </svg>
                  <span class="govuk-visually-hidden">Open information about how priority is determined</span>
                </button>
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Comments</h2>
        </div>
        <div class="govuk-summary-card__content">
          {# Add Comment Form - Only show if issue is open #}
          {% if issue.status != 'closed' %}
          <div class="govuk-!-margin-bottom-6">
            <form action="/services/{{ service.id }}/issues/{{ issue.id }}/comments" method="post">
              <input type="hidden" name="_csrf" value="{{ csrfToken }}">
              <div class="govuk-form-group">
                <h3 class="govuk-label-wrapper">
                  <label class="govuk-label govuk-label--s" for="comment">
                    Add a comment
                  </label>
                </h3>
                <textarea class="govuk-textarea" id="comment" name="comment" rows="3" required></textarea>
              </div>
              <button type="submit" class="govuk-button govuk-!-margin-bottom-0 govuk-!-margin-top-0">Add
                comment</button>
            </form>
          </div>
          {% endif %}

          {# Comments List #}
          {% if issue.comments and issue.comments.length > 0 %}
          <div class="govuk-!-margin-bottom-6">
            {% for comment in issue.comments %}
            <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

            <strong>{{ comment.created_by_name }}</strong>
            {% if comment.type == 'closure' %}
            closed this issue
            {% elif comment.type == 'reopen' %}
            reopened this issue
            {% else %}
            commented
            {% endif %}
            <p class="govuk-body govuk-!-margin-bottom-1">
              {% if comment.type == 'closure' %}
              Issue closed: {{ comment.content | nl2br | safe }}
              {% elif comment.type == 'reopen' %}
              Issue reopened: {{ comment.content | nl2br | safe }}
              {% else %}
              {{ comment.content | nl2br | safe }}
              {% endif %}
            </p>
            <p class="govuk-body-s">{{ comment.created_at | date('D MMMM YYYY, HH:mm') }} |
              <a href="#" class="govuk-link govuk-link--no-visited-state"
                onclick="openDeleteModal('{{ comment.id }}', '{{ comment.content | truncate(50) }}'); return false;">Delete
                comment</a>
            </p>
            {% endfor %}
          </div>
          {% else %}
          <p class="govuk-body govuk-!-margin-bottom-6">No comments yet.</p>
          {% endif %}
        </div>
      </div>


    </div>
    <div class="govuk-grid-column-one-third">

      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Actions</h2>
        </div>
        <div class="govuk-summary-card__content">
          <ul class="govuk-list govuk-list--spaced">
            <li>
              <a href="/services/{{ service.id }}/issues/{{ issue.id }}/edit" class="govuk-link govuk-link--no-visited-state">Edit issue</a>
            </li>
            <li>
              {% if issue.status == 'closed' %}
              <a href="#" class="govuk-link govuk-link--no-visited-state" onclick="openReopenModal(); return false;">Reopen issue</a>
              {% else %}
              <a href="#" class="govuk-link govuk-link--no-visited-state" onclick="openCloseModal(); return false;">Close issue</a>
              {% endif %}
            </li>
          </ul>
        </div>
      </div>

    

      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Issue details</h2>
        </div>
        <div class="govuk-summary-card__content">
          <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Assigned to
              </dt>
              <dd class="govuk-summary-list__value">
                {% if issue.assigned_to %}
                  {{ issue.assigned_to_name }}
                {% else %}
                  Not assigned
                {% endif %}
              </dd>
              <dd class="govuk-summary-list__actions">
                <a href="#" class="govuk-link govuk-link--no-visited-state" onclick="openAssignModal(); return false;">
                  {% if issue.assigned_to %}Reassign{% else %}Assign{% endif %}
                </a>
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Source of discovery
              </dt>
              <dd class="govuk-summary-list__value">
                {{ issue.source_of_discovery }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Created
              </dt>
              <dd class="govuk-summary-list__value">
                {{ issue.created_at | date('D MMMM YYYY') }}
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Resolution plan</h2>
        </div>
        <div class="govuk-summary-card__content">
          <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Plan to fix
              </dt>
              <dd class="govuk-summary-list__value">
                {% if issue.planned_fix %}
               Yes
                {% else %}
                No
                {% endif %}
              </dd>
            </div>
            {% if issue.planned_fix %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Planned fix date
              </dt>
              <dd class="govuk-summary-list__value">
                {{ issue.planned_fix_date | date('D MMMM YYYY') }}
              </dd>
            </div>
            {% else %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Reason for not fixing
              </dt>
              <dd class="govuk-summary-list__value">
                {{ issue.not_fixing_reason | nl2br | safe }}
              </dd>
            </div>
            {% endif %}
          </dl>
        </div>
      </div>

    </div>
  </div>
</div>

{# Delete Comment Modal #}
<div class="govuk-modal-overlay" id="delete-modal" style="display: none;" role="dialog" aria-labelledby="modal-title"
  aria-describedby="modal-description" aria-modal="true" tabindex="-1">
  <div class="govuk-modal">
    <div class="govuk-modal__header">
      <h2 class="govuk-modal__title" id="modal-title">Delete comment</h2>
      <button class="govuk-modal__close" aria-label="Close modal" onclick="closeDeleteModal()">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="govuk-modal__content">
      <div id="modal-description">
        <div class="govuk-warning-text">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-warning-text__assistive">Warning</span>
            This action cannot be undone
          </strong>
        </div>
        <p class="govuk-body">Are you sure you want to delete this comment?</p>
        <p class="govuk-body" id="comment-preview"></p>
      </div>
      <form id="delete-comment-form" method="post" style="display: inline;">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
        <div class="govuk-button-group">
          <button type="submit" class="govuk-button govuk-button--warning" data-module="govuk-button"
            data-prevent-double-click="true">
            Delete comment
          </button>
          <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button"
            onclick="closeDeleteModal()">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Close Issue Modal #}
<div class="govuk-modal-overlay" id="close-modal" style="display: none;" role="dialog"
  aria-labelledby="close-modal-title" aria-describedby="close-modal-description" aria-modal="true" tabindex="-1">
  <div class="govuk-modal">
    <div class="govuk-modal__header">
      <h2 class="govuk-modal__title" id="close-modal-title">Close issue</h2>
      <button class="govuk-modal__close" aria-label="Close modal" onclick="closeCloseModal()">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="govuk-modal__content">
      <div id="close-modal-description">
        <div class="govuk-warning-text">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-warning-text__assistive">Important</span>
            Please provide a reason for closing this issue
          </strong>
        </div>
        <form id="close-issue-form" method="post" action="/services/{{ service.id }}/issues/{{ issue.id }}/close">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
          <div class="govuk-form-group">
            <label class="govuk-label" for="close-comment">
              Closure comment
            </label>
            <div id="close-comment-hint" class="govuk-hint">
              Explain why this issue is being closed. For example, "Issue has been fixed" or "No longer relevant".
            </div>
            <textarea class="govuk-textarea" id="close-comment" name="comment" rows="3"
              aria-describedby="close-comment-hint" required></textarea>
          </div>
          <div class="govuk-button-group">
            <button type="submit" class="govuk-button govuk-button--warning" data-module="govuk-button"
              data-prevent-double-click="true">
              Close issue
            </button>
            <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button"
              onclick="closeCloseModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# Reopen Issue Modal #}
<div class="govuk-modal-overlay" id="reopen-modal" style="display: none;" role="dialog"
  aria-labelledby="reopen-modal-title" aria-describedby="reopen-modal-description" aria-modal="true" tabindex="-1">
  <div class="govuk-modal">
    <div class="govuk-modal__header">
      <h2 class="govuk-modal__title" id="reopen-modal-title">Reopen issue</h2>
      <button class="govuk-modal__close" aria-label="Close modal" onclick="closeReopenModal()">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="govuk-modal__content">
      <div id="reopen-modal-description">
        <form id="reopen-issue-form" method="post" action="/services/{{ service.id }}/issues/{{ issue.id }}/reopen">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
          <div class="govuk-form-group">
            <label class="govuk-label" for="reopen-comment">
              Reopen comment
            </label>
            <div id="reopen-comment-hint" class="govuk-hint">
              Explain why this issue is being reopened.
            </div>
            <textarea class="govuk-textarea" id="reopen-comment" name="comment" rows="3"
              aria-describedby="reopen-comment-hint" required></textarea>
          </div>
          <div class="govuk-button-group">
            <button type="submit" class="govuk-button" data-module="govuk-button" data-prevent-double-click="true">
              Reopen issue
            </button>
            <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button"
              onclick="closeReopenModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# Priority Info Modal #}
<div class="govuk-modal-overlay" id="priority-info-modal" style="display: none;" role="dialog"
  aria-labelledby="priority-info-modal-title" aria-describedby="priority-info-modal-description" aria-modal="true" tabindex="-1">
  <div class="govuk-modal">
    <div class="govuk-modal__header">
      <h2 class="govuk-modal__title" id="priority-info-modal-title">How priority is determined</h2>
      <button class="govuk-modal__close" aria-label="Close modal" onclick="closePriorityInfoModal()">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="govuk-modal__content">
      <div id="priority-info-modal-description">
        <h3 class="govuk-heading-s">High priority</h3>
        <p class="govuk-body">Issues that prevent users from completing essential tasks or accessing critical information. These issues have the most severe impact on accessibility.</p>
        
        <h3 class="govuk-heading-s">High / Medium priority</h3>
        <p class="govuk-body">Issues that significantly impact users' ability to complete tasks but may have workarounds available. These issues require prompt attention.</p>

        <h3 class="govuk-heading-s">Medium priority</h3>
        <p class="govuk-body">Issues that make tasks more difficult but don't prevent users from completing them. These issues should be addressed but are less urgent.</p>
        
        <h3 class="govuk-heading-s">Low priority</h3>
        <p class="govuk-body">Issues that are minor inconveniences or affect non-essential functionality. These issues should still be fixed but have the least impact on accessibility.</p>
      </div>
      <div class="govuk-button-group">
        <button type="button" class="govuk-button" data-module="govuk-button" onclick="closePriorityInfoModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

{# Assign Issue Modal #}
<div class="govuk-modal-overlay" id="assign-modal" style="display: none;" role="dialog"
  aria-labelledby="assign-modal-title" aria-describedby="assign-modal-description" aria-modal="true" tabindex="-1">
  <div class="govuk-modal">
    <div class="govuk-modal__header">
      <h2 class="govuk-modal__title" id="assign-modal-title">Assign issue</h2>
      <button class="govuk-modal__close" aria-label="Close modal" onclick="closeAssignModal()">
        <span aria-hidden="true">×</span>
      </button>
    </div>
    <div class="govuk-modal__content">
      <div id="assign-modal-description">
        <form id="assign-issue-form" method="post" action="/services/{{ service.id }}/issues/{{ issue.id }}/assign">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
          <div class="govuk-form-group">
            <label class="govuk-label" for="assign-to">
              Assign to
            </label>
            <div id="assign-to-hint" class="govuk-hint">
              Select a user from your department or enter a new email address
            </div>
            <select class="govuk-select" id="assign-to" name="assign_to" aria-describedby="assign-to-hint">
              <option value="">Select a user</option>
              {% for user in users %}
                <option value="{{ user.id }}" {% if issue.assigned_to == user.id %}selected{% endif %}>
                  {{ user.first_name }} {{ user.last_name }} ({{ user.email }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="govuk-form-group">
            <label class="govuk-label" for="new-user-email">
              Or enter a new email address
            </label>
            <input class="govuk-input" id="new-user-email" name="new_user_email" type="email" autocomplete="email">
          </div>
          <div class="govuk-form-group">
            <label class="govuk-label" for="assign-comment">
              Assignment comment
            </label>
            <div id="assign-comment-hint" class="govuk-hint">
              Add a note about why you're assigning this issue
            </div>
            <textarea class="govuk-textarea" id="assign-comment" name="comment" rows="3"
              aria-describedby="assign-comment-hint"></textarea>
          </div>
          <div class="govuk-button-group">
            <button type="submit" class="govuk-button" data-module="govuk-button" data-prevent-double-click="true">
              Assign issue
            </button>
            <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button"
              onclick="closeAssignModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .govuk-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .govuk-modal {
    background: white;
    padding: 30px;
    border-radius: 5px;
    max-width: 500px;
    width: 90%;
    position: relative;
    margin: 20px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .govuk-modal__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }

  .govuk-modal__title {
    margin: 0;
    padding-right: 45px;
  }

  .govuk-modal__close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 44px;
    height: 44px;
    background: none;
    border: 0;
    cursor: pointer;
    padding: 10px;
    color: #505a5f;
    font-size: 24px;
  }

  .govuk-modal__close:hover {
    color: #0b0c0c;
    background: #f3f2f1;
  }

  .govuk-modal__close:focus {
    outline: 3px solid #ffdd00;
    outline-offset: 0;
    background-color: #ffdd00;
  }

  .govuk-modal__content {
    margin-bottom: 20px;
  }

  .govuk-button--warning {
    background-color: #d4351c;
  }

  .govuk-button--warning:hover {
    background-color: #aa2a16;
  }

  @media (max-width: 40.0625em) {
    .govuk-modal {
      margin: 15px;
      padding: 15px;
      width: 95%;
    }

    .govuk-modal__close {
      top: 10px;
      right: 10px;
    }
  }

  /* At 400% zoom, make the modal wider */
  @media (min-width: 160em) {
    .govuk-modal {
      max-width: 95%;
      width: 95%;
      margin: 20px;
      padding: 30px;
    }
  }

  /* Hide scrollbar when modal is open */
  body.modal-open {
    overflow: hidden;
  }

  .priority-info-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
    color: #505A5F;
    text-decoration: none;
    min-width: 22px;
    min-height: 22px;
    width: 22px;
    height: 22px;
    vertical-align: middle;
    position: relative;
    top: -1px;
  }

  .priority-info-button:hover {
    color: #0b0c0c;
  }

  .priority-info-button:focus {
    outline: 3px solid #ffdd00;
    outline-offset: 0;
    background-color: #ffdd00;
    color: #0b0c0c;
  }

  .priority-info-button::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: #0b0c0c;
    color: white;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 100;
  }

  .priority-info-button:hover::after {
    opacity: 1;
  }

  .priority-info-icon {
    vertical-align: middle;
    margin: 0;
    position: relative;
    top: 1px;
  }
</style>

<script>
  let previousActiveElement;

  function openDeleteModal(commentId, commentPreview) {
    // Store the currently focused element
    previousActiveElement = document.activeElement;

    const modal = document.getElementById('delete-modal');
    const body = document.body;

    // Show modal
    modal.style.display = 'flex';
    body.classList.add('modal-open');

    // Set form action
    document.getElementById('delete-comment-form').action = `/services/{{ service.id }}/issues/{{ issue.id }}/comments/${commentId}/delete`;

    // Set comment preview
    document.getElementById('comment-preview').textContent = `"${commentPreview}..."`;

    // Focus the modal
    modal.focus();

    // Trap focus within modal
    trapFocus(modal);
  }

  function closeDeleteModal() {
    const modal = document.getElementById('delete-modal');
    const body = document.body;

    modal.style.display = 'none';
    body.classList.remove('modal-open');

    // Return focus to the element that opened the modal
    if (previousActiveElement) {
      previousActiveElement.focus();
    }
  }

  function trapFocus(modal) {
    const focusableElements = modal.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );

    const firstFocusableElement = focusableElements[0];
    const lastFocusableElement = focusableElements[focusableElements.length - 1];

    modal.addEventListener('keydown', function (e) {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      }
    });

    // Focus first focusable element
    firstFocusableElement.focus();
  }

  // Close modal when clicking outside
  document.addEventListener('click', function (event) {
    const modal = document.querySelector('.govuk-modal');
    const overlay = document.getElementById('delete-modal');
    if (event.target === overlay && modal && !modal.contains(event.target)) {
      closeDeleteModal();
    }
  });

  // Close modal on escape key
  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape' && document.getElementById('delete-modal').style.display === 'flex') {
      closeDeleteModal();
    }
  });

  function openCloseModal() {
    previousActiveElement = document.activeElement;

    const modal = document.getElementById('close-modal');
    const body = document.body;

    modal.style.display = 'flex';
    body.classList.add('modal-open');

    modal.focus();
    trapFocus(modal);
  }

  function closeCloseModal() {
    const modal = document.getElementById('close-modal');
    const body = document.body;

    modal.style.display = 'none';
    body.classList.remove('modal-open');

    if (previousActiveElement) {
      previousActiveElement.focus();
    }
  }

  function openReopenModal() {
    previousActiveElement = document.activeElement;

    const modal = document.getElementById('reopen-modal');
    const body = document.body;

    modal.style.display = 'flex';
    body.classList.add('modal-open');

    modal.focus();
    trapFocus(modal);
  }

  function closeReopenModal() {
    const modal = document.getElementById('reopen-modal');
    const body = document.body;

    modal.style.display = 'none';
    body.classList.remove('modal-open');

    if (previousActiveElement) {
      previousActiveElement.focus();
    }
  }

  // Add event listeners for new modals
  document.addEventListener('click', function (event) {
    const closeModal = document.querySelector('#close-modal .govuk-modal');
    const closeOverlay = document.getElementById('close-modal');
    const reopenModal = document.querySelector('#reopen-modal .govuk-modal');
    const reopenOverlay = document.getElementById('reopen-modal');

    if (event.target === closeOverlay && closeModal && !closeModal.contains(event.target)) {
      closeCloseModal();
    }
    if (event.target === reopenOverlay && reopenModal && !reopenModal.contains(event.target)) {
      closeReopenModal();
    }
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') {
      if (document.getElementById('close-modal').style.display === 'flex') {
        closeCloseModal();
      }
      if (document.getElementById('reopen-modal').style.display === 'flex') {
        closeReopenModal();
      }
    }
  });

  function openPriorityInfoModal() {
    previousActiveElement = document.activeElement;
    const button = previousActiveElement;
    button.setAttribute('aria-expanded', 'true');

    const modal = document.getElementById('priority-info-modal');
    const body = document.body;

    modal.style.display = 'flex';
    body.classList.add('modal-open');

    modal.focus();
    trapFocus(modal);
  }

  function closePriorityInfoModal() {
    const modal = document.getElementById('priority-info-modal');
    const body = document.body;
    const button = document.querySelector('.priority-info-button');
    
    if (button) {
      button.setAttribute('aria-expanded', 'false');
    }

    modal.style.display = 'none';
    body.classList.remove('modal-open');

    if (previousActiveElement) {
      previousActiveElement.focus();
    }
  }

  // Add event listener for priority info modal
  document.addEventListener('click', function (event) {
    const priorityModal = document.querySelector('#priority-info-modal .govuk-modal');
    const priorityOverlay = document.getElementById('priority-info-modal');

    if (event.target === priorityOverlay && priorityModal && !priorityModal.contains(event.target)) {
      closePriorityInfoModal();
    }
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape' && document.getElementById('priority-info-modal').style.display === 'flex') {
      closePriorityInfoModal();
    }
  });

  function openAssignModal() {
    previousActiveElement = document.activeElement;

    const modal = document.getElementById('assign-modal');
    const body = document.body;

    modal.style.display = 'flex';
    body.classList.add('modal-open');

    modal.focus();
    trapFocus(modal);
  }

  function closeAssignModal() {
    const modal = document.getElementById('assign-modal');
    const body = document.body;

    modal.style.display = 'none';
    body.classList.remove('modal-open');

    if (previousActiveElement) {
      previousActiveElement.focus();
    }
  }

  // Add event listener for assign modal
  document.addEventListener('click', function (event) {
    const assignModal = document.querySelector('#assign-modal .govuk-modal');
    const assignOverlay = document.getElementById('assign-modal');

    if (event.target === assignOverlay && assignModal && !assignModal.contains(event.target)) {
      closeAssignModal();
    }
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape' && document.getElementById('assign-modal').style.display === 'flex') {
      closeAssignModal();
    }
  });

  // Handle form submission
  document.getElementById('assign-issue-form').addEventListener('submit', function(e) {
    const select = document.getElementById('assign-to');
    const email = document.getElementById('new-user-email');
    
    if (!select.value && !email.value) {
      e.preventDefault();
      alert('Please select a user or enter an email address');
    }
  });
</script>

{% endblock %}